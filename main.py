import os
import time
import string
import random
import telebot
import asyncio
import pyautogui
import psutil
import subprocess
import webbrowser
from httpcore import ConnectTimeout
from httpx import ConnectTimeout as HTTPXConnectTimeout

bot = telebot.TeleBot('5958478560:AAF-8gKrVZB67PZsBLvQvcGj4ozqs5SJKag')

def main(bot):
    def attcookiegpm(message):
        for processo in psutil.process_iter(['name']):
            if processo.info['name'] == 'msedge.exe':
                # Encerrar o processo
                processo.kill()
                for processo in psutil.process_iter(['name']):
                    if processo.info['name'] == 'msedge.exe':
                        # Encerrar o processo
                        processo.kill()
                        for processo in psutil.process_iter(['name']):
                            if processo.info['name'] == 'msedge.exe':
                                # Encerrar o processo
                                processo.kill()
                                for processo in psutil.process_iter(['name']):
                                    if processo.info['name'] == 'msedge.exe':
                                        # Encerrar o processo
                                        processo.kill()
                                        for processo in psutil.process_iter(['name']):
                                            if processo.info['name'] == 'msedge.exe':
                                                # Encerrar o processo
                                                processo.kill()
                                                for processo in psutil.process_iter(['name']):
                                                    if processo.info['name'] == 'msedge.exe':
                                                        # Encerrar o processo
                                                        processo.kill()
                                                        for processo in psutil.process_iter(['name']):
                                                            if processo.info['name'] == 'msedge.exe':
                                                                # Encerrar o processo
                                                                processo.kill()
                                                                for processo in psutil.process_iter(['name']):
                                                                    if processo.info['name'] == 'msedge.exe':
                                                                        # Encerrar o processo
                                                                        processo.kill()
                                                                        for processo in psutil.process_iter(['name']):
                                                                            if processo.info['name'] == 'msedge.exe':
                                                                                # Encerrar o processo
                                                                                processo.kill()
                                                                                for processo in psutil.process_iter(['name']):
                                                                                    if processo.info['name'] == 'msedge.exe':
                                                                                        # Encerrar o processo
                                                                                        processo.kill()
                                                                                        for processo in psutil.process_iter(['name']):
                                                                                            if processo.info['name'] == 'msedge.exe':
                                                                                                # Encerrar o processo
                                                                                                processo.kill()
                                                                                                for processo in psutil.process_iter(['name']):
                                                                                                    if processo.info['name'] == 'msedge.exe':
                                                                                                        # Encerrar o processo
                                                                                                        processo.kill()
                                                                                                        break


        # Inicializar o driver do Selenium para o navegador padr√£o
        url = "https://sirtecba.gpm.srv.br/index.php"
        webbrowser.open(url)

        time.sleep(10)

        pyautogui.moveTo(-1007, 304)
        pyautogui.click()
        pyautogui.write('bob')

        time.sleep(1)

        pyautogui.moveTo(-998, 356)
        pyautogui.click()
        pyautogui.write('808062023')

        time.sleep(1)

        pyautogui.moveTo(-992, 477)
        pyautogui.click(clicks=3)

        pass

    def equipecommand(message):
        pyautogui.moveTo(97, 919)
        time.sleep(2)
        pyautogui.click()

        pyautogui.write('equipe')
        pyautogui.press('enter')
        pass

    def asbuiltcommand(message):
        pyautogui.moveTo(97, 919)
        time.sleep(2)
        pyautogui.click()

        pyautogui.write('asbuilt')
        pyautogui.press('enter')
        pass

    def producaodbcommand(message):
        pyautogui.moveTo(97, 919)
        time.sleep(2)
        pyautogui.click()

        pyautogui.write('producaodb')
        pyautogui.press('enter')
        pass

    def v5command(message):
        pyautogui.moveTo(97, 919)
        time.sleep(2)
        pyautogui.click()

        pyautogui.write('v5')
        pyautogui.press('enter')
        pass

    def conquista_1(message):
        pyautogui.moveTo(97, 919)
        time.sleep(2)
        pyautogui.click()

        pyautogui.write('avancogpm')
        pyautogui.press('enter')

        time.sleep(5)

        pyautogui.moveTo(97, 919)
        time.sleep(2)
        pyautogui.click()

        pyautogui.write('conquista_1')
        pyautogui.press('enter')
        pass

    def conquista_2(message):
        pyautogui.moveTo(97, 919)
        time.sleep(2)
        pyautogui.click()

        pyautogui.write('avancogpm')
        pyautogui.press('enter')

        time.sleep(5)

        pyautogui.moveTo(97, 919)
        time.sleep(2)
        pyautogui.click()

        pyautogui.write('conquista_2')
        pyautogui.press('enter')
        pass

    def itapetinga(message):
        pyautogui.moveTo(97, 919)
        time.sleep(2)
        pyautogui.click()

        pyautogui.write('avancogpm')
        pyautogui.press('enter')

        time.sleep(5)

        pyautogui.moveTo(97, 919)
        time.sleep(2)
        pyautogui.click()

        pyautogui.write('itapetinga')
        pyautogui.press('enter')
        pass

    def barreiras(message):
        pyautogui.moveTo(97, 919)
        time.sleep(2)
        pyautogui.click()

        pyautogui.write('avancogpm')
        pyautogui.press('enter')

        time.sleep(5)

        pyautogui.moveTo(97, 919)
        time.sleep(2)
        pyautogui.click()

        pyautogui.write('barreiras')
        pyautogui.press('enter')
        pass

    def lapa(message):
        pyautogui.moveTo(97, 919)
        time.sleep(2)
        pyautogui.click()

        pyautogui.write('avancogpm')
        pyautogui.press('enter')

        time.sleep(5)

        pyautogui.moveTo(97, 919)
        time.sleep(2)
        pyautogui.click()

        pyautogui.write('lapa')
        pyautogui.press('enter')
        pass

    def ibotirama(message):
        pyautogui.moveTo(97, 919)
        time.sleep(2)
        pyautogui.click()

        pyautogui.write('avancogpm')
        pyautogui.press('enter')

        time.sleep(5)

        pyautogui.moveTo(97, 919)
        time.sleep(2)
        pyautogui.click()

        pyautogui.write('ibotirama')
        pyautogui.press('enter')
        pass

    def jequie(message):
        pyautogui.moveTo(97, 919)
        time.sleep(2)
        pyautogui.click()

        pyautogui.write('avancogpm')
        pyautogui.press('enter')

        time.sleep(5)

        pyautogui.moveTo(97, 919)
        time.sleep(2)
        pyautogui.click()

        pyautogui.write('jequie')
        pyautogui.press('enter')
        pass

    def irece(message):
        pyautogui.moveTo(97, 919)
        time.sleep(2)
        pyautogui.click()

        pyautogui.write('avancogpm')
        pyautogui.press('enter')

        time.sleep(5)

        pyautogui.moveTo(97, 919)
        time.sleep(2)
        pyautogui.click()

        pyautogui.write('irece')
        pyautogui.press('enter')
        pass

    def guanami(message):
        pyautogui.moveTo(97, 919)
        time.sleep(2)
        pyautogui.click()

        pyautogui.write('avancogpm')
        pyautogui.press('enter')

        time.sleep(5)

        pyautogui.moveTo(97, 919)
        time.sleep(2)
        pyautogui.click()

        pyautogui.write('guanambi')
        pyautogui.press('enter')
        pass

    
    def enviarcookiegpm(text):
        print(text)
        pass

    def commandsbob(message):

        for processo in psutil.process_iter(['name']):
            if processo.info['name'] == 'main.exe':
                # Encerrar o processo
                processo.kill()
                for processo in psutil.process_iter(['name']):
                    if processo.info['name'] == 'main.exe':
                        # Encerrar o processo
                        processo.kill()
                        for processo in psutil.process_iter(['name']):
                            if processo.info['name'] == 'main.exe':
                                # Encerrar o processo
                                processo.kill()
                                break
        
        # Caminho para o arquivo .exe
        caminho_arquivo = 'C:/Users/TIBA0036/Desktop/BOB/dist/main.exe'

        # Comando para abrir em tela cheia no Windows
        comando = f'start /max {caminho_arquivo}'

        # Executa o comando
        subprocess.call(comando, shell=True)
        pass

    def screenshotbot(message):
        quantidade_letras = 20
        letras_aleatorias = ''

        for _ in range(quantidade_letras):
            letras_aleatorias += random.choice(string.ascii_letters)

        # Local onde a captura de tela ser√° salva
        screenshot_path = f'screenshot{letras_aleatorias}.png'

        # Captura de tela
        pyautogui.screenshot(screenshot_path)

        # Fun√ß√£o ass√≠ncrona para enviar a captura de tela
        async def send_screenshot(message):
            # Envia a captura de tela usando o bot do Telegram
            try:
                with open(screenshot_path, 'rb') as photo:
                    bot.send_photo(message.chat.id, photo=photo)  # Provide chat_id here
            except (ConnectTimeout, HTTPXConnectTimeout):
                print('Erro de tempo limite durante o envio da captura de tela.')
            except Exception as e:
                print('Ocorreu um erro ao enviar a captura de tela:', str(e))

            # Remove o arquivo de captura de tela
            os.remove(screenshot_path)

        # Create and set the event loop explicitly
        loop = asyncio.new_event_loop()
        asyncio.set_event_loop(loop)

        # Executa a fun√ß√£o ass√≠ncrona e aguarda a conclus√£o
        loop.run_until_complete(send_screenshot(message))
        loop.close()
        pass

    @bot.message_handler(commands=['start', 'help'])
    def send_welcome(message):
        markup = telebot.types.InlineKeyboardMarkup(row_width=2)
        item1 = telebot.types.InlineKeyboardButton('HELP', callback_data='btn1')
        item2 = telebot.types.InlineKeyboardButton('LOG', callback_data='btn2')
        item3 = telebot.types.InlineKeyboardButton('PRINT', callback_data='btn3')
        item4 = telebot.types.InlineKeyboardButton('EQUIPE', callback_data='btn4')
        item5 = telebot.types.InlineKeyboardButton('ASBUILT', callback_data='btn5')
        item6 = telebot.types.InlineKeyboardButton('PRODU√á√ÉO DB', callback_data='btn6')
        item7 = telebot.types.InlineKeyboardButton('V5', callback_data='btn7')
        item8 = telebot.types.InlineKeyboardButton('AVAN√áO GPM', callback_data='btn8')
        item10 = telebot.types.InlineKeyboardButton('COOKIE GPM', callback_data='btn20')
        item11 = telebot.types.InlineKeyboardButton('Abrir GPM Cookies', callback_data='btn21')
        item9 = telebot.types.InlineKeyboardButton('INICIAR BOB', callback_data='btn9')
        markup.add(item1, item2, item3, item4, item5, item6, item7, item8, item10, item11, item9)

        bot.send_message(message.chat.id, "ü§ñ ùë™ùë∂ùë¥ùë®ùëµùë´ùë∂ùë∫ ü§ñ", reply_markup=markup)

    @bot.callback_query_handler(func=lambda call: True)
    def handle_callback_query(call):
        if call.data == 'btn1':
            send_welcome(call.message)

        elif call.data == 'btn2':
            bot.answer_callback_query(call.id, "N√£o funciona ainda!")

        elif call.data == 'btn3':
            screenshotbot(call.message)
            
        elif call.data == 'btn4':
            equipecommand(call.message)

        elif call.data == 'btn5':
            asbuiltcommand(call.message)

        elif call.data == 'btn6':
            producaodbcommand(call.message)

        elif call.data == 'btn7':
            v5command(call.message)

        elif call.data == 'btn8':
            markup = telebot.types.InlineKeyboardMarkup(row_width=3)
            item9 = telebot.types.InlineKeyboardButton('Conquista 1', callback_data='btn10')
            item10 = telebot.types.InlineKeyboardButton('Conquista 2', callback_data='btn11')
            item11 = telebot.types.InlineKeyboardButton('Itapetinga', callback_data='btn12')
            item12 = telebot.types.InlineKeyboardButton('Barreiras', callback_data='btn13')
            item13 = telebot.types.InlineKeyboardButton('Lapa', callback_data='btn14')
            item14 = telebot.types.InlineKeyboardButton('Ibotirama', callback_data='btn15')
            item15 = telebot.types.InlineKeyboardButton('Jequi√©', callback_data='btn16')
            item16 = telebot.types.InlineKeyboardButton('Irec√™', callback_data='btn17')
            item17 = telebot.types.InlineKeyboardButton('Guanambi', callback_data='btn18')
            item18 = telebot.types.InlineKeyboardButton('HELP', callback_data='btn19')

            markup.add(item9, item10, item11, item12, item13, item14, item15, item16, item17, item18)
            bot.send_message(call.message.chat.id, "Selecione uma op√ß√£o:", reply_markup=markup)

        elif call.data == 'btn9':
            commandsbob(call.message)

        elif call.data == 'btn10':
            conquista_1(call.message)

        elif call.data == 'btn11':
            conquista_2(call.message)

        elif call.data == 'btn12':
            itapetinga(call.message)

        elif call.data == 'btn13':
            barreiras(call.message)

        elif call.data == 'btn14':
            lapa(call.message)

        elif call.data == 'btn15':
            ibotirama(call.message)

        elif call.data == 'btn16':
            jequie(call.message)

        elif call.data == 'btn17':
            irece(call.message)

        elif call.data == 'btn18':
            guanami(call.message)

        elif call.data == 'btn19':
            send_welcome(call.message)

        elif call.data == 'btn20':
            bot.send_message(call.message.chat.id, "Ol√°! Me envie qual o novo cookie do GPM")

            # Espere a resposta
            @bot.message_handler(func=lambda message: True)
            def handle_confirmation(message):
                text = message.text
                enviarcookiegpm(text)
                # Confirme que o usu√°rio respondeu
                bot.send_message(message.chat.id, "Mensagem recebida! Obrigado.")

                # Encerra a conversa
                bot.stop_polling()
            
        elif call.data == 'btn21':
            attcookiegpm(call.message)

    bot.polling()


while True:
    try:
        main(bot)
    except (ConnectTimeout, HTTPXConnectTimeout):
        print('Erro de conex√£o')
    except (Exception) as e:
        print(e)
        time.sleep(30)